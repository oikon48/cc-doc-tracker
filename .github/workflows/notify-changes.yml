name: Notify Documentation Changes

on:
  workflow_call:
    inputs:
      commit_sha:
        description: 'Commit SHA to analyze'
        required: true
        type: string
      changed_files_count:
        description: 'Number of changed files'
        required: true
        type: number
      tracker_name:
        description: 'Tracker name for display'
        required: true
        type: string
    secrets:
      DISCORD_WEBHOOK_URL:
        required: true
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.commit_sha }}  # Checkout the specific commit that was pushed
          fetch-depth: 2  # Need previous commit for diff

      - name: Get changed files
        id: get-changes
        run: |
          # Check if parent commit exists (handle initial commit)
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff HEAD~1 --name-only -- docs/)
          else
            # First commit - list all docs
            CHANGED_FILES=$(git ls-tree --name-only -r HEAD -- docs/)
          fi

          if [ -z "$CHANGED_FILES" ]; then
            echo "No doc changes found"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT

          # Format file list for display (limit to 15 files)
          FILE_LIST=$(echo "$CHANGED_FILES" | head -15 | sed 's/^/‚Ä¢ /')
          REMAINING=$(echo "$CHANGED_FILES" | tail -n +16 | wc -l | tr -d ' ')

          if [ "$REMAINING" -gt 0 ]; then
            FILE_LIST="${FILE_LIST}"$'\n'"... and ${REMAINING} more files"
          fi

          # Output using heredoc for multiline
          echo "file_list<<EOF" >> $GITHUB_OUTPUT
          echo "$FILE_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Get diff stats (handle initial commit)
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            DIFF_STAT=$(git diff HEAD~1 --stat -- docs/ | tail -5)
          else
            DIFF_STAT="Initial commit"
          fi
          echo "diff_stat<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF_STAT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Get brief diff content for summary (limit to 200 lines)
          # Use docs/ to include all files including subdirectories
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            DIFF_CONTENT=$(git diff HEAD~1 -- docs/ 2>/dev/null | head -200 || echo "")
          else
            DIFF_CONTENT="Initial commit - all files are new"
          fi
          echo "diff_content<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate summary with Claude Code
        id: summarize
        if: steps.get-changes.outputs.has_changes == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            ‰ª•‰∏ã„ÅÆ„Éâ„Ç≠„É•„É°„É≥„ÉàÂ§âÊõ¥„ÇíÂàÜÊûê„Åó„ÄÅÊó•Êú¨Ë™û„ÅßÁ∞°ÊΩî„Å´Ë¶ÅÁ¥Ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

            ## Â§âÊõ¥„Éï„Ç°„Ç§„É´:
            ${{ steps.get-changes.outputs.file_list }}

            ## Â§âÊõ¥Áµ±Ë®à:
            ${{ steps.get-changes.outputs.diff_stat }}

            ## Â∑ÆÂàÜÂÜÖÂÆπÔºà‰∏ÄÈÉ®Ôºâ:
            ${{ steps.get-changes.outputs.diff_content }}

            ‰ª•‰∏ã„ÅÆÂΩ¢Âºè„Åß3Êñá‰ª•ÂÜÖ„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ:
            [Â§âÊõ¥„ÅÆÊ¶ÇË¶Å„ÇíË™¨Êòé„ÄÇ„Å©„ÅÆ„Çà„ÅÜ„Å™Ê©üËÉΩ„ÇÑÊÉÖÂ†±„ÅåÊõ¥Êñ∞/ËøΩÂä†/ÂâäÈô§„Åï„Çå„Åü„Åã]
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --model claude-opus-4-5
            --max-turns 1

      - name: Extract summary text
        id: extract-summary
        if: steps.get-changes.outputs.has_changes == 'true'
        run: |
          # Default summary if AI fails
          DEFAULT_SUMMARY="„Éâ„Ç≠„É•„É°„É≥„Éà„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü„ÄÇË©≥Á¥∞„ÅØ„Ç≥„Éü„ÉÉ„Éà„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ"

          if [ -f "${{ steps.summarize.outputs.execution_file }}" ]; then
            # Extract the last assistant message from execution log
            # Note: Claude API content is an array of content blocks [{type: "text", text: "..."}]
            SUMMARY=$(cat "${{ steps.summarize.outputs.execution_file }}" | \
              jq -r 'map(select(.role == "assistant")) | last | if .content | type == "array" then (.content[] | select(.type == "text") | .text) else .content // empty end' 2>/dev/null || echo "")

            # Clean up the summary (remove markdown if any)
            SUMMARY=$(echo "$SUMMARY" | sed 's/```[^`]*```//g' | tr '\n' ' ' | head -c 1000)

            if [ -z "$SUMMARY" ]; then
              SUMMARY="$DEFAULT_SUMMARY"
            fi
          else
            SUMMARY="$DEFAULT_SUMMARY"
          fi

          # Store raw summary (JSON escaping happens later in Discord step)
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        if: steps.get-changes.outputs.has_changes == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          FILE_LIST: ${{ steps.get-changes.outputs.file_list }}
          SUMMARY: ${{ steps.extract-summary.outputs.summary }}
          TRACKER_NAME: ${{ inputs.tracker_name }}
          CHANGED_FILES_COUNT: ${{ inputs.changed_files_count }}
        run: |
          TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ inputs.commit_sha }}"
          REPO_URL="https://github.com/${{ github.repository }}"

          # Truncate summary if too long for Discord embed (max 1024 chars per field)
          if [ ${#SUMMARY} -gt 900 ]; then
            SUMMARY="${SUMMARY:0:897}..."
          fi

          # Build Discord embed payload using jq (auto-escapes special characters and handles newlines)
          jq -n \
            --arg title "üìù ${TRACKER_NAME} „Éâ„Ç≠„É•„É°„É≥„ÉàÊõ¥Êñ∞" \
            --arg desc "ÂÖ¨Âºè„Éâ„Ç≠„É•„É°„É≥„Éà„Å´Â§âÊõ¥„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü" \
            --arg count "$CHANGED_FILES_COUNT" \
            --arg commit_url "$COMMIT_URL" \
            --arg repo_url "$REPO_URL" \
            --arg file_list "$FILE_LIST" \
            --arg summary "$SUMMARY" \
            --arg footer "${TRACKER_NAME} | GitHub Actions" \
            --arg ts "$TIMESTAMP" \
            '{
              "embeds": [{
                "title": $title,
                "description": $desc,
                "color": 5814783,
                "fields": [
                  {"name": "üìä Â§âÊõ¥„Éï„Ç°„Ç§„É´Êï∞", "value": $count, "inline": true},
                  {"name": "üîó „É™„É≥„ÇØ", "value": ("[„Ç≥„Éü„ÉÉ„Éà](" + $commit_url + ") | [„É™„Éù„Ç∏„Éà„É™](" + $repo_url + ")"), "inline": true},
                  {"name": "üìã Â§âÊõ¥„Éï„Ç°„Ç§„É´", "value": ("```\n" + $file_list + "\n```")},
                  {"name": "ü§ñ AIË¶ÅÁ¥Ñ", "value": $summary}
                ],
                "footer": {"text": $footer},
                "timestamp": $ts
              }]
            }' > /tmp/discord_payload.json

          # Debug: show payload
          echo "Discord payload:"
          cat /tmp/discord_payload.json

          # Send to Discord
          HTTP_CODE=$(curl -s -o /tmp/discord_response.txt -w "%{http_code}" \
            -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @/tmp/discord_payload.json)

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ Discord notification sent successfully (HTTP $HTTP_CODE)"
          else
            echo "‚ùå Failed to send Discord notification (HTTP $HTTP_CODE)"
            cat /tmp/discord_response.txt
            exit 1
          fi

      - name: Skip notification (no changes)
        if: steps.get-changes.outputs.has_changes != 'true'
        run: |
          echo "‚ÑπÔ∏è No documentation changes detected, skipping notification"
