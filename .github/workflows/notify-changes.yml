name: Notify Documentation Changes

on:
  workflow_call:
    inputs:
      commit_sha:
        description: 'Commit SHA to analyze'
        required: true
        type: string
      changed_files_count:
        description: 'Number of changed files'
        required: true
        type: number
      tracker_name:
        description: 'Tracker name for display'
        required: true
        type: string
    secrets:
      DISCORD_WEBHOOK_URL:
        required: true
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      id-token: write  # Required for Claude Code Action OIDC authentication

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.commit_sha }}
          fetch-depth: 2

      - name: Get changed files
        id: get-changes
        run: |
          # Check if parent commit exists (handle initial commit)
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff HEAD~1 --name-only -- docs/)
          else
            # First commit - list all docs
            CHANGED_FILES=$(git ls-tree --name-only -r HEAD -- docs/)
          fi

          if [ -z "$CHANGED_FILES" ]; then
            echo "No doc changes found"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT

          # Format file list for display (limit to 15 files)
          FILE_LIST=$(echo "$CHANGED_FILES" | head -15 | sed 's/^/• /')
          REMAINING=$(echo "$CHANGED_FILES" | tail -n +16 | wc -l | tr -d ' ')

          if [ "$REMAINING" -gt 0 ]; then
            FILE_LIST="${FILE_LIST}"$'\n'"... and ${REMAINING} more files"
          fi

          # Output using heredoc for multiline
          echo "file_list<<EOF" >> $GITHUB_OUTPUT
          echo "$FILE_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Get diff stats (handle initial commit)
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            DIFF_STAT=$(git diff HEAD~1 --stat -- docs/ | tail -5)
          else
            DIFF_STAT="Initial commit"
          fi
          echo "diff_stat<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF_STAT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Get brief diff content for summary (limit to 50 lines to avoid GitHub Actions memory limit)
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            DIFF_CONTENT=$(git diff HEAD~1 -- docs/ 2>/dev/null | head -50 || echo "")
          else
            DIFF_CONTENT="Initial commit - all files are new"
          fi
          echo "diff_content<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate summary with Claude Code
        id: summarize
        if: steps.get-changes.outputs.has_changes == 'true'
        continue-on-error: true
        uses: anthropics/claude-code-action@28f83620103c48a57093dcc2837eec89e036bb9f  # beta
        with:
          prompt: |
            以下のドキュメント変更を分析し、日本語で簡潔に要約してください。

            ## 変更ファイル:
            ${{ steps.get-changes.outputs.file_list }}

            ## 変更統計:
            ${{ steps.get-changes.outputs.diff_stat }}

            ## 差分内容（一部）:
            ${{ steps.get-changes.outputs.diff_content }}

            3文以内で変更の概要を説明してください。どのような機能や情報が更新/追加/削除されたかを記載してください。
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --model claude-sonnet-4-5
            --max-turns 3
            --max-tokens 1024
            --json-schema '{"type":"object","properties":{"summary":{"type":"string","description":"日本語での変更要約（3文以内）"}},"required":["summary"],"additionalProperties":false}'

      - name: Extract summary text
        id: extract-summary
        if: steps.get-changes.outputs.has_changes == 'true'
        env:
          STRUCTURED_OUTPUT: ${{ steps.summarize.outputs.structured_output }}
          EXECUTION_FILE: ${{ steps.summarize.outputs.execution_file }}
        run: |
          # Default summary if AI fails or returns empty
          DEFAULT_SUMMARY="ドキュメントが更新されました。詳細はコミットをご確認ください。"
          SUMMARY=""

          # Try to extract from structured_output first (using env var to avoid quote issues)
          if [ -n "$STRUCTURED_OUTPUT" ] && [ "$STRUCTURED_OUTPUT" != "null" ]; then
            SUMMARY=$(echo "$STRUCTURED_OUTPUT" | jq -r '.summary // empty' 2>/dev/null || echo "")
          fi

          # Fallback to execution_file if structured_output is empty
          if [ -z "$SUMMARY" ] && [ -n "$EXECUTION_FILE" ] && [ -f "$EXECUTION_FILE" ]; then
            SUMMARY=$(cat "$EXECUTION_FILE" | \
              jq -r 'map(select(.role == "assistant")) | last |
                if .content | type == "array" then
                  (.content[] | select(.type == "text") | .text)
                else
                  .content // empty
                end' 2>/dev/null || echo "")
            # Clean up the summary
            SUMMARY=$(echo "$SUMMARY" | sed 's/```[^`]*```//g' | tr '\n' ' ' | head -c 1000)
          fi

          # Use default if still empty
          if [ -z "$SUMMARY" ]; then
            SUMMARY="$DEFAULT_SUMMARY"
          fi

          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        if: steps.get-changes.outputs.has_changes == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          FILE_LIST: ${{ steps.get-changes.outputs.file_list }}
          SUMMARY: ${{ steps.extract-summary.outputs.summary }}
          TRACKER_NAME: ${{ inputs.tracker_name }}
          CHANGED_FILES_COUNT: ${{ inputs.changed_files_count }}
        run: |
          TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ inputs.commit_sha }}"
          REPO_URL="https://github.com/${{ github.repository }}"

          # Truncate summary if too long for Discord embed (max 1024 chars per field)
          if [ ${#SUMMARY} -gt 900 ]; then
            SUMMARY="${SUMMARY:0:897}..."
          fi

          # Build Discord embed payload using jq (auto-escapes special characters and handles newlines)
          jq -n \
            --arg title "${TRACKER_NAME} ドキュメント更新" \
            --arg desc "公式ドキュメントに変更が検出されました" \
            --arg count "$CHANGED_FILES_COUNT" \
            --arg commit_url "$COMMIT_URL" \
            --arg repo_url "$REPO_URL" \
            --arg file_list "$FILE_LIST" \
            --arg summary "$SUMMARY" \
            --arg footer "${TRACKER_NAME} | GitHub Actions" \
            --arg ts "$TIMESTAMP" \
            '{
              "embeds": [{
                "title": $title,
                "description": $desc,
                "color": 5814783,
                "fields": [
                  {"name": "変更ファイル数", "value": $count, "inline": true},
                  {"name": "リンク", "value": ("[コミット](" + $commit_url + ") | [リポジトリ](" + $repo_url + ")"), "inline": true},
                  {"name": "変更ファイル", "value": ("```\n" + $file_list + "\n```")},
                  {"name": "AI要約", "value": $summary}
                ],
                "footer": {"text": $footer},
                "timestamp": $ts
              }]
            }' > /tmp/discord_payload.json

          # Debug: show payload
          echo "Discord payload:"
          cat /tmp/discord_payload.json

          # Send to Discord
          HTTP_CODE=$(curl -s -o /tmp/discord_response.txt -w "%{http_code}" \
            -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @/tmp/discord_payload.json)

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Discord notification sent successfully (HTTP $HTTP_CODE)"
          else
            echo "Failed to send Discord notification (HTTP $HTTP_CODE)"
            cat /tmp/discord_response.txt
            exit 1
          fi

      - name: Skip notification (no changes)
        if: steps.get-changes.outputs.has_changes != 'true'
        run: |
          echo "No documentation changes detected, skipping notification"
